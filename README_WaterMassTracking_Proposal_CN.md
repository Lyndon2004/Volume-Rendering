# 水团追踪与分析工具开发方案

**日期：** 2026-01-21  
**项目：** 海洋水团可视化 (OceanSTCube)  
**状态：** 提案 / 草稿  

## 1. 背景与动机

基于 2026年1月19日 与海洋学研究团队的外部讨论，我们确定了当前可视化系统的关键缺陷。

*   **当前局限：** 现有的直接体绘制（Direct Volume Rendering）系统侧重于“场的展示”。对于展示长时序（几十年）数据，计算代价过高，且无法将特定的水团视为独立的、可追踪的实体（Entity）。
*   **研究者需求：**
    *   **从“内部漫游”转向“实体追踪”：** 专家并不需要进入数据内部漫游，而是迫切需要看到水团的 **边界（Boundaries）** 和 **轨迹（Trajectories）**。
    *   **高性能：** 需要大幅减少加载和渲染时间，以支持跨度几十年的分析。
    *   **多变量定义：** “水团”是由溶解氧（DO）、盐度（Salinity）、温度（Temperature）以及特定定义（如“模态水”）共同界定的。

## 2. 拟定方案：“水团对象化”框架

我们建议将开发重点从 **直接体绘制 (DVR)** 转向 **等值面与特征提取 (Isosurface & Feature Extraction)** 技术。这将水团视为几何物体，而非密度云。

### 2.1 核心功能：多变量水团定义
用户不再局限于单一的传递函数，而是可以通过布尔逻辑或多维传递函数来定义水团。

*   **界面：** 一个“水团定义”面板。
*   **逻辑示例：**
    > “选择 (Temp < 10°C) 且 (Salinity > 34.5 psu) 且 (Oxygen < 200 µmol/L) 的区域”
*   **技术实现：**
    *   **预处理：** 在数据转换阶段，根据这些条件预先计算二值掩码（Binary Masks）或符号距离场（SDFs）。
    *   **实时：** 使用计算着色器（Compute Shader）实时检查组合阈值（灵活但较慢），或直接加载预烘焙的 Mesh（最快）。

### 2.2 核心功能：时空追踪（“轨迹”）
一旦水团被定义为独立对象：
1.  **质心计算：** 计算每个时间步长内该水团的质心（Center of Mass）。
2.  **路径可视化：** 绘制一条连接各个时间点质心的 3D 样条曲线。
3.  **体积与形状指标：** 作为 2D 图表叠加层，展示体积（$km^3$）或表面积随时间的变化。

### 2.3 性能优化（针对长时序）
针对梁琳琳提出的关于几十年数据的担忧：
1.  **等值面提取 (Marching Cubes)：** 我们不加载完整的原始体数据，而是离线或在加载时提取每帧水团的 **网格 (Mesh)**（外壳）。
2.  **数据轻量化：** Mesh 文件通常只有 MB 级别，而体数据是 GB 级别。这使得在几秒钟内流畅播放 50 年的数据成为可能。
3.  **LOD (多细节层次)：** 快速拖动时间轴时使用简化网格，暂停时显示高精度网格。

## 3. 技术架构路线图

### 第一阶段：数据转换 (Python 后端)
*   **目标：** 支持多变量过滤与几何提取。
*   **任务：**
    *   [ ] 更新 `check_data_format.py`，支持处理盐度和温度数据。
    *   [ ] 创建 `extract_isosurface.py`，使用 `skimage.measure.marching_cubes` 或 VTK。
        *   **输入：** 原始数据（DO, Salt, Temp）。
        *   **逻辑：** 基于用户配置进行过滤（例如 NumPy 布尔索引）。
        *   **输出：** 每一帧的 `.obj` 或 `.fbx` 模型序列。
    *   [ ] 创建 `calculate_trajectory.py`，输出每帧质心坐标的 JSON 列表。

### 第二阶段：渲染引擎 (Unity 前端)
*   **目标：** 可视化“外壳”和“路径”。
*   **任务：**
    *   [ ] **Mesh 序列播放器：** 编写脚本高效切换 Mesh 对象（避免 `Instantiate/Destroy` 带来的卡顿），像定格动画一样播放水团形状。
    *   [ ] **轨迹渲染器：** 使用 Unity `LineRenderer` 绘制路径。根据时间进行颜色编码（起点=蓝色，终点=红色）。
    *   [ ] **幽灵/洋葱皮效果：**（可选）显示前几年水团的淡出轮廓，以可视化“流动”趋势。

### 第三阶段：UI 与交互
*   **目标：** 面向研究者的控制面板。
*   **任务：**
    *   [ ] **时间轴滑块：** 针对长序列（年/十年）进行优化。
    *   [ ] **定义编辑器：** 用于温度、盐度、氧气范围的滑块。
    *   [ ] **2D 分析面板：** 显示“水团体积 vs. 时间”的仪表盘图表。

## 4. 工作分解与下一步

| 优先级 | 任务 | 负责人 | 预估时间 |
| :--- | :--- | :--- | :--- |
| **高** | **原型 Mesh 提取**：编写 Python 脚本，将自定义的“水团”（例如特定氧气范围）转换为 3D Mesh 文件。 | 后端 | 2 天 |
| **高** | **Mesh 播放器**：编写 Unity 脚本，像播放动画一样播放 Mesh 序列。 | 前端 | 2 天 |
| **中** | **多源数据合并**：确保温度和盐度数据与氧气数据在空间上对齐。 | 数据组 | 3 天 |
| **中** | **轨迹线**：在 Unity 中绘制移动路径。 | 前端 | 1 天 |

## 5. 需向海洋学家确认的问题（下次会议）
1.  **阈值细节：** 该数据集中“模态水”的确切范围是什么？（例如：温度 16-18°C？）
2.  **连续性：** 如果一个水团在某时刻分裂成两个（分叉），轨迹线应该跟随哪一个？较大的那个吗？
